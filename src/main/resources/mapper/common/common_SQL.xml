<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="common">

	<!-- 해시태그 -->
	<select id="hashTag" parameterType='hashmap'
	   resultType="hashmap">
	   <![CDATA[
		SELECT /* common.hashTag */
		       HASH_IDXX
		   	 , HASH_SEQC
		     , HASH_TAGG
		  FROM (
		        SELECT
		               HASH_IDXX
		             , HASH_SEQC
		             , HASH_TAGG
		             , SUM(LENGTH(HASH_TAGG) + 4 ) OVER (PARTITION BY HASH_IDXX ORDER BY HASH_SEQC) AS RUNNING_LENGTH
		    	  FROM TB_HASHTG
			    )
		WHERE RUNNING_LENGTH <= 25
		  AND HASH_IDXX = #{HASH_IDXX}     
	 ]]>
	 </select>
	
	<insert id="insertFile" parameterType="hashMap">
  		<![CDATA[
	    INSERT INTO TM_FILEXM (
			       , FILE_IDXX     /* 파일 번호 / 파일 유형(각 PK) */
			       , FILE_SEQC     /* 파일 번호2(001) */
			       , USER_IDXX     /* 파일 올린 사용자번호 */
			       , FILE_OGNM     /* 원본 파일명 */
			       , FILE_SVNM     /* 저장 파일명 */
			       , FILE_SIZE     /* 파일 사이즈 */
			       , FILE_PATH     /* 파일 경로 */
			       , DELT_YSNO     /* 삭제 여부 */
			       , REGE_DATE     /* 파일 등록일 */
			) VALUES (
			         #{FILE_IDXX}   /* 파일 번호 / 파일 유형(각 PK) */
			         ]]>
			       <if test="FILE_SEQC == null"> 
		            <![CDATA[
				   , (SELECT LPAD(NVL(MAX(TO_NUMBER(FILE_SEQC)), 0) + 1, 3, '0') AS FILE_SEQC  
						FROM TM_FILEXM
					   WHERE FILE_IDXX = #{FILE_IDXX}) /* 파일 번호 순차채번 */
				       ]]>
		            </if>
		            <if test="FILE_SEQC != null">
		            <![CDATA[
		           , #{FILE_SEQC}   /* 파일 번호 순차채번 */
				       ]]>
		            </if>
		            <![CDATA[
			       
			       , #{USER_IDXX}   /* 파일 올린 사용자번호 */
			       , #{FILE_OGNM}   /* 원본 파일명 */
			       , #{FILE_SVNM}   /* 저장 파일명 */
			       , #{FILE_SIZE}   /* 파일 사이즈 */
			       , #{FILE_PATH}   /* 파일 경로 */
			       , #{DELT_YSNO}   /* 삭제 여부 */
			       , SYSDATE        /* 파일 등록일 */
	         )
 		 ]]>
	 </insert>
	
	 <!-- 부모 카테고리 -->
	<select id="pCate" parameterType='hashmap'
	   resultType="hashmap">
	   <![CDATA[
	       SELECT /*common.pCate*/
	    		  COMD_CODE AS CATE_CODE												/* 부모 카테고리 코드 */
	    		, COMD_NAME AS CATE_NAME    											/* 부모 카테고리 이름 */
	    		, CODE_OPT1 AS CATE_PATH												/*  카테고리 경로 */
	    		, CODE_OPT2 AS IMAG_SRCC												/*  카테고리 이미지 경로 */
			FROM TB_CODEXD
	       WHERE COMM_CODE = 'CATE_IDXX'
	         AND LENGTH(COMD_CODE) = 1
		ORDER BY COMD_CODE
	 ]]>
	 </select>
   
	 <!-- 자식 카테고리 -->
	<select id="cCate" parameterType='hashmap'
	   resultType="hashmap">
	   <![CDATA[
	      SELECT /*common.cCate*/
	    	      SUBSTR(COMD_CODE,'1','1')  AS PARENTS_CODE							/* 부모 카테고리 코드 */
	            , COMD_CODE AS CATE_CODE												/* 카테고리 코드 */
	    		, COMD_NAME AS CATE_NAME    											/* 자식 카테고리 이름 */
	    		, CODE_OPT1 AS CATE_PATH												/* 자식 카테고리 경로 */
			FROM TB_CODEXD
	  	   WHERE COMM_CODE = 'CATE_IDXX'
	         AND LENGTH(COMD_CODE) = 3
		ORDER BY COMD_CODE
	      
	 ]]>
	 </select>
   
   
	<!-- 카테고리검색 -->
	<select id="getRegi" parameterType='hashmap'
	   resultType="hashmap">
	   <![CDATA[
	   	  SELECT /*common.getRegi*/
                  CASE WHEN LENGTH(COMD_CODE) = 1
                            THEN 1
                       ELSE 2
                   END AS REGI_LEVL                                                     /* 지역 레벨 */
	            , SUBSTR(COMD_CODE,'1','1')  AS PARENTS_CODE							/* 부모 지역 코드 */
	            , COMD_CODE AS REGI_CODE												/* 부모 지역 코드 */
	    		, COMD_NAME AS REGI_NAME   											    /* 부모 지역 이름 */
			FROM TB_CODEXD
	  	   WHERE COMM_CODE = 'REGI_CODE'
		ORDER BY COMD_CODE
	 ]]>
	 </select>
	 
	<!--모임 like insert -->
	<insert id="likeInsert" parameterType="hashmap">
     <![CDATA[
	     /*common.likdeInsert*/
	     INSERT INTO TM_HEARTS (
	     		      LIKE_IDXX
	     		    , USER_NUMB
	      ) VALUES (
	                  #{LIKE_IDXX}
	                , #{USER_NUMB}
	                )
            ]]>
	</insert>

	<!--모임 like Delete -->
	<delete id="likeDelete" parameterType="hashmap">
    <![CDATA[
	    /*common.likeDelete*/
	    DELETE TM_HEARTS 
	     WHERE LIKE_IDXX = #{LIKE_IDXX}  
	       AND USER_NUMB = #{USER_NUMB}  
            ]]>
	</delete>
	
	<!--모임 like insert -->
	<insert id="follow" parameterType="hashmap">
     <![CDATA[
	     /*common.follow*/
	     INSERT INTO TB_FOLLOW (
	     		      USER_NUMB
	     		    , FOLW_USER
	      ) VALUES (
	                  #{USER_NUMB}
	                , #{FOLW_USER}
	                )
            ]]>
	</insert>
	
	<!--모임 like Delete -->
	<delete id="unfollow" parameterType="hashmap">
    <![CDATA[
	    /*common.unfollow*/
	    DELETE TB_FOLLOW 
	     WHERE USER_NUMB = #{USER_NUMB}  
	       AND FOLW_USER = #{FOLW_USER}  
            ]]>
	</delete>
	
	<!-- 전자정부 페이징 -->
	<sql id="pagingPre">
		<![CDATA[
		SELECT
			AAA.*
		FROM(
			SELECT
				COUNT(*) OVER() AS TOTAL_COUNT,
				AA.*
			FROM(
		]]>
	</sql>
	
	<sql id="pagingPost">
		<![CDATA[
			) AA
		) AAA
		WHERE
			AAA.RNUM BETWEEN #{START} AND #{END}
		]]>
	</sql>

</mapper>