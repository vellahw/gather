<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 
	작성자:Hwai
    작성일:23.12.19
-->
<mapper namespace="gather">
	
	<!-- 
	작성자:Hwai
    작성일:23.12.19
    (게더Search쿼리)
    -->
   <select id="getGather" parameterType="hashmap" resultType="hashmap">
      <![CDATA[
       	SELECT /*mainPage.getGather*/
       			*
		  FROM (  
		       	  SELECT /*mainPage.getGather*/              
		                  GATH_IDXX AS MOIM_IDXX
		                , GATH_TITL AS MOIM_TITL
		                , GATH_CNTT AS MOIM_CNTT
		                , GATH_IMAG AS MOIM_IMAG
		                , CATE_IDXX
		                , PARENTS_CATE
		                , CHILD_CATE
		                , PRES_PEOP
		                , APPR_YSNO
		                , MOIM_AGEE
		                , MOIM_COST
		                , APPR_GNDR
		                , GNDR_CODE
		                , PREGI_NAME
		                , REGI_NAME
		                , USER_NICK
		                , USER_IMAG
		                , SMAL_DATE
		                , FULL_DATE
		                , LIKE_COUNT
		                , REGG_DATE
		                 ]]>
		                 <if test="USER_NUMB != null">
		      			 	<![CDATA[
		                , getAmILike (GATH_IDXX, #{USER_NUMB}) AS LIKE_YSNO					/* 로그인유저 좋아요 유무 */
		                , getAmIBkmk (GATH_IDXX, #{USER_NUMB}) AS BKMK_YSNO					/* 로그인유저 북마크 유무 */
		                  	]]>
		     			 </if>
		     			  <if test="USER_NUMB == null">
		      			 	<![CDATA[
		                , getAmILike (GATH_IDXX, null) AS LIKE_YSNO							/* 좋아요 유무 없음 0 리턴 */
		                , getAmIBkmk (GATH_IDXX, null) AS BKMK_YSNO							/* 북마크 유무 없음 0 리턴 */
		                  	]]>
		     			 </if>
		     			 <![CDATA[
					FROM VW_GATHER
				   WHERE 1=1
		      ]]>
		      <if test="MOIM_IDXX != null">
		      	 <![CDATA[
		         	 AND GATH_IDXX = #{MOIM_IDXX}
		         ]]>
		      </if>
		      <if test="CATE_IDXX != null and CATE_IDXX != 'all'">
		      	 <![CDATA[
		         	 AND CATE_IDXX LIKE '%'||#{CATE_IDXX}||'%'
		         ]]>
		      </if>
		      <if test="WEATH_CATE != null">
		      	 <![CDATA[
		         	 AND CATE_IDXX IN ]]>
		         	  <foreach collection="WEATH_CATE" item="WEATH_CATE" open="(" separator="," close=")">
		       			 #{WEATH_CATE}
		    		  </foreach>
		      </if>
		      <if test="CITY_CODE != null">
		      	 <![CDATA[
		         	 AND REGI_CODE LIKE '%'||#{CITY_CODE}||'%'
		         ]]>
		      </if>
		      	<![CDATA[
		      	ORDER BY REGG_DATE
		      	)
		      	]]>
      <if test="WEATH_CATE != null || CITY_CODE != null">
       <![CDATA[
      	   WHERE ROWNUM <= 12
      	]]>
      </if>
   </select>
   
   	<!-- 
	작성자:Hwai
    작성일:23.12.19
    (게더 맴버 추출, 로그인 회원 마스터 유무.)
    -->
	<select id="getGatherMember" resultType="hashmap">
    <![CDATA[
        SELECT /*gather.getGahterMember*/
	             A.MOIM_IDXX														/* 모임번호 */		
	           , CASE WHEN A.USER_NUMB = C.USER_NUMB 			
                           THEN 'Y'
                      ELSE 'N'
                  END AS MAST_YSNO										/* 방장유무 */
	           , A.USER_NUMB														/* 회원번호 */
	           , B.USER_NICK														/* 회원닉네임 */
	           , CASE WHEN LENGTH(B.FILE_SVNM) > 32 
	                  		 THEN '/resources/img/upload/profile/'|| A.USER_NUMB ||'/'|| B.FILE_SVNM  
	               	  ELSE '/resources/img/basic/profile/' || B.FILE_SVNM 
	             END AS USER_IMAG 											/* 회원프사 */
	           , A.BANN_YSNO														/* 강퇴유무 */
	           , A.WAIT_YSNO														/* 대기유무 */
	           , A.PART_DATE
	           , CASE WHEN D.REVW_IDXX IS NOT NULL			
                           THEN 'Y'
                      ELSE 'N'
                  END AS REVW_YSNO										/* 리뷰유무 */
	        FROM TB_MEMBER A
	   LEFT JOIN TM_USERXM B
	          ON A.USER_NUMB = B.USER_NUMB
	   LEFT JOIN TM_GATHER C
	          ON A.MOIM_IDXX = C.GATH_IDXX
	   LEFT JOIN TB_REVIEW D 
            ON A.MOIM_IDXX = D.MOIM_IDXX        
	       WHERE A.MOIM_IDXX = #{MOIM_IDXX}
	         ]]>
	         <if test="USER_NUMB != null">
		     <![CDATA[
	         AND A.USER_NUMB = #{USER_NUMB}
	         ]]>
	         </if>
	         <![CDATA[
	       ORDER BY A.PART_DATE
	      	]]>
    </select>

   	<!-- 
	작성자:Hwai
    작성일:23.12.19
    (모임일정이 지난 게더 추출)
    -->
	<select id="getEnddedGahter" resultType="hashmap">
    <![CDATA[
        SELECT /*gather.getEnddedGahter*/
        	   GATH_IDXX
          FROM TM_GATHER
         WHERE TO_CHAR(CONCAT(CONCAT(MOIM_DATE, ' '), MOIM_TIME)) <= #{currentDateString}
           AND ENDD_YSNO = 'N'
     ]]>
    </select>
    
    <!-- 
	작성자:Hwai
    작성일:23.12.19
    (게더마감)
    -->
   <update id="setGatherEnd" parameterType="hashmap">
       <![CDATA[
      UPDATE /*gather.setGatherEnd*/
      		 TM_GATHER SET
		     ENDD_YSNO = 'Y'
	   WHERE GATH_IDXX = #{GATH_IDXX}
       ]]>
   </update>
</mapper>