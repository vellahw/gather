<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 
	작성자:Hwai
    작성일:23.12.19
-->
<mapper namespace="gather">
	
   <!-- 게더 메인화면 -->
   <select id="mainGather" parameterType='hashmap'
      resultType="hashmap">
      <![CDATA[
         SELECT /*mainPage.mainGather*/
         		  RNUM
                , TYPE                				/* 게더 타입 ('Taste': 취항 , 'Hot': 핫한게더 , 'Like':좋아요 많은 순 'Region': 지역) */
                , GATH_IDXX	AS MOIM_IDXX			/* 게더 ID */
                , GATH_TITL AS MOIM_TITL			/* 게더 제목 */
                , GATH_CNTT	AS MOIM_CNTT			/* 게더 내용 */
                , GATH_IMAG	AS MOIM_IMAG			/* 게더 대표이미지 */
                , CATE_IDXX							/* 카테고리 코드 */
                , PARENTS_CATE						/* 상위 카테고리 */
                , CHILD_CATE						/* 하위 카테고리 */
                , PRES_PEOP							/* 현재 인원: (현재인원/최대인원)*/
                , APPR_YSNO							/* 승인여부 */
                , APPR_LMIT							/* 모임 제한 */
                , PREGI_NAME						/* 부모지역명 */
                , REGI_NAME							/* 지역명 */
                , USER_NUMB							/* 방장 회원번호 */
                , USER_NICK							/* 방장 닉네임 */
                , USER_IMAG							/* 방장 프로필사진 */
                , SMAL_DATE							/* 모임시간 (날짜 형식 MM.dd(day) 오전/오후 HH:mm) */
                , FULL_DATE							/* 날짜 형식 (YYYY년 M월 오전/오후 HH:mm) */
                , LIKE_COUNT						/* 좋아요 수 */
                , REGG_DATE							/* 개설일 */
                , ENDD_YSNO							/* 모임 시간*/
                ]]>
                 <if test="USER_NUMB != null">
      			 	<![CDATA[
                , getAmILike (GATH_IDXX, #{USER_NUMB}) AS LIKE_YSNO					/* 로그인유저 좋아요 유무 */
                , getAmIBkmk (GATH_IDXX, #{USER_NUMB}) AS BKMK_YSNO					/* 로그인유저 북마크 유무 */
                  	]]>
     			 </if>
     			 <if test="USER_NUMB == null">
      			 	<![CDATA[
                , getAmILike (GATH_IDXX, null) AS LIKE_YSNO							/* 비로그인 시 좋아요 유무 없음 0 리턴 */
                , getAmIBkmk (GATH_IDXX, null) AS BKMK_YSNO							/* 비로그인 시 북마크 유무 없음 0 리턴 */
                  	]]>
     			 </if>
     			 <![CDATA[
             FROM (
             		]]>
                  	<if test="USER_NUMB != null">
      			 	<![CDATA[
                  	(
                  
                    	SELECT  ROW_NUMBER() OVER (ORDER BY REGG_DATE DESC) RNUM
                              , 'Taste' AS TYPE
                    		  , GATH_IDXX
                    		  , GATH_TITL
                    		  , GATH_CNTT
		                      , GATH_IMAG
		                      , CATE_IDXX
		                      , PARENTS_CATE
		                      , CHILD_CATE
		                      , PRES_PEOP
		                      , APPR_YSNO
							  , APPR_LMIT
		                      , PREGI_NAME
		                      , REGI_NAME
		                      , USER_NUMB
		                      , USER_NICK
		                      , USER_IMAG
		                      , SMAL_DATE
		                      , FULL_DATE
		                      , LIKE_COUNT
		                      , REGG_DATE
		                      , ENDD_YSNO
		                   FROM VW_GATHER
		                  WHERE CATE_IDXX IN ( 
                                    		  SELECT CATE_IDXX
                                       			FROM TB_URCATE
                                      		   WHERE USER_NUMB = #{USER_NUMB})
                 )
        UNION ALL
        		]]>
     			 </if>
     			 <![CDATA[
                (
		        			SELECT ROW_NUMBER() OVER (ORDER BY REGG_DATE DESC) RNUM
			                     ,'Hot' AS TYPE
			                     , GATH_IDXX
			                     , GATH_TITL
			                     , GATH_CNTT
			                     , GATH_IMAG
			                     , CATE_IDXX
			                     , PARENTS_CATE
			                     , CHILD_CATE
			                     , PRES_PEOP
			                     , APPR_YSNO
								 , APPR_LMIT
			                     , PREGI_NAME
			                     , REGI_NAME
			                     , USER_NUMB
			                     , USER_NICK
			                     , USER_IMAG
			                     , SMAL_DATE
			                     , FULL_DATE
			                     , LIKE_COUNT
			                     , REGG_DATE
			                     , ENDD_YSNO
			                  FROM VW_GATHER
			                 WHERE (MEMB_COUNT/MAXX_PEOP)*100 > 70
                 )
        UNION ALL
                 (
                 		 SELECT 
	                             ROWNUM RNUM
	                           , 'Like' AS TYPE
	                           , GATH_IDXX
	                           , GATH_TITL
	                           , GATH_CNTT
	                           , GATH_IMAG
	                           , CATE_IDXX
	                           , PARENTS_CATE
	                           , CHILD_CATE
	                           , PRES_PEOP
	                           , APPR_YSNO
							   , APPR_LMIT
	                           , PREGI_NAME
	                           , REGI_NAME
	                           , USER_NUMB
	                           , USER_NICK
	                           , USER_IMAG
	                           , SMAL_DATE
	                           , FULL_DATE
	                           , LIKE_COUNT
	                           , REGG_DATE
	                           , ENDD_YSNO
	                       FROM ( SELECT 
	                                     GATH_IDXX
	                                   , GATH_TITL
	                                   , GATH_CNTT
	                                   , GATH_IMAG
	                                   , CATE_IDXX
	                                   , PARENTS_CATE
	                                   , CHILD_CATE
	                                   , PRES_PEOP
	                                   , APPR_YSNO
									   , APPR_LMIT
	                                   , PREGI_NAME
	                                   , REGI_NAME
	                                   , USER_NUMB
	                                   , USER_NICK
	                                   , USER_IMAG
	                                   , SMAL_DATE
	                                   , FULL_DATE
	                                   , LIKE_COUNT
	                                   , REGG_DATE
	                                   , ENDD_YSNO
	                                FROM VW_GATHER
	                               ORDER BY LIKE_COUNT DESC
                      			)
                 )
        
        ]]>
		<if test="USER_NUMB != null">
      		<![CDATA[
        UNION ALL
                 (
                  			SELECT ROW_NUMBER() OVER (ORDER BY REGG_DATE DESC) RNUM
			                     , 'Region' AS TYPE
			                     , GATH_IDXX
			                     , GATH_TITL
			                     , GATH_CNTT
			                     , GATH_IMAG
			                     , CATE_IDXX
			                     , PARENTS_CATE
			                     , CHILD_CATE
			                     , PRES_PEOP
			                     , APPR_YSNO
								 , APPR_LMIT
			                     , PREGI_NAME
			                     , REGI_NAME
			                     , USER_NUMB
			                     , USER_NICK
			                     , USER_IMAG
			                     , SMAL_DATE
			                     , FULL_DATE
			                     , LIKE_COUNT
			                     , REGG_DATE
			                     , ENDD_YSNO
			                  FROM VW_GATHER
			                 WHERE REGI_CODE IN (
			                                     SELECT REGI_CODE
			                                       FROM TB_URREGI
			                                      WHERE USER_NUMB = #{USER_NUMB}
			                                     
			                                     )
			                 )
			]]>
		</if>
      	    <![CDATA[
                 		)
                 WHERE RNUM <= 12
                   AND ENDD_YSNO = 'N'
      		]]>
   </select>
	
	<!-- 
	작성자:Hwai
    작성일:23.12.19
    (게더Search쿼리)
    -->
   <select id="getGather" parameterType="hashmap" resultType="hashmap">
      <![CDATA[
       	SELECT /*mainPage.getGather*/
       			*
		  FROM (  
		       	  SELECT /*mainPage.getGather*/              
		                  GATH_IDXX AS MOIM_IDXX										   	/* 게더아이디 */
		                , GATH_TITL AS MOIM_TITL										   	/* 게더 제목 */
		                , GATH_CNTT AS MOIM_CNTT								           	/* 게더 내용 */
		                , GATH_IMAG AS MOIM_IMAG								            /* 게더 대표 이미지 */
		                , CATE_IDXX															/* 카테고리 코드 */
		                , PARENTS_CATE														/* 부모 카테고리 */
		                , CHILD_CATE														/* 자식 카테고리 */
                		, MAXX_PEOP															/* 최대 인원 */
		                , PRES_PEOP															/* 현재 인원  n/n */
		                , MEMB_COUNT														/* 현재 인원수 */
		                , MOIM_COST															/* 참가 비용 */
		                , APPR_YSNO															/* 승인 여부 */
		                , MINN_AGEE						 									/* 최소나이 */
                		, MAXX_AGEE															/* 최대나이 */
						, APPR_LMIT															/* 모임 제한 KR */
		                , GNDR_CODE															/* 모임 성별 코드 */											
		                , PREGI_NAME														/* 부모 지역명 */
		                , REGI_NAME															/* 자식 지역명 */
		                , USER_NUMB															/* 방장 회원번호 */
		                , USER_NICK															/* 방장 닉네임 */
		                , USER_IMAG															/* 방장 프로필 사진 */
		                , SELF_INTR															/* 방장 자기소개 */
		                , SMAL_DATE															/* 날짜 형식 MM.dd(day) 오전/오후 HH:mm */
		                , FULL_DATE															/* 날짜 형식 YYYY년 M월 오전/오후 HH:mm */
		                , LIKE_COUNT														/* 좋아요 수 */
		                , REGG_DATE															/* 모임 개설일 */
		                , ENDD_YSNO															/* 모임 마감 유무 */
		                 ]]>
		                 <if test="USER_NUMB != null">
		      			 	<![CDATA[
		                , getAmILike (GATH_IDXX, #{USER_NUMB}) AS LIKE_YSNO					/* 로그인유저 좋아요 유무 */
		                , getAmIBkmk (GATH_IDXX, #{USER_NUMB}) AS BKMK_YSNO					/* 로그인유저 북마크 유무 */
		                  	]]>
		     			 </if>
		     			  <if test="USER_NUMB == null">
		      			 	<![CDATA[
		                , getAmILike (GATH_IDXX, null) AS LIKE_YSNO							/* 좋아요 유무 없음 0 리턴 */
		                , getAmIBkmk (GATH_IDXX, null) AS BKMK_YSNO							/* 북마크 유무 없음 0 리턴 */
		                  	]]>
		     			 </if>
		     			 <![CDATA[
					FROM VW_GATHER
				   WHERE 1=1
		      ]]>
		      <if test="MOIM_IDXX != null">
		      	 <![CDATA[
		         	 AND GATH_IDXX = #{MOIM_IDXX}
		         ]]>
		      </if>
		      <if test="CATE_IDXX != null and CATE_IDXX != 'all'">
		      	 <![CDATA[
		         	 AND CATE_IDXX LIKE '%'||#{CATE_IDXX}||'%'
		         ]]>
		      </if>
		      <if test="WEATH_CATE != null">
		      	 <![CDATA[
		         	 AND CATE_IDXX IN ]]>
		         	  <foreach collection="WEATH_CATE" item="WEATH_CATE" open="(" separator="," close=")">
		       			 #{WEATH_CATE}
		    		  </foreach>
		      </if>
		      <if test="CITY_CODE != null">
		      	 <![CDATA[
		         	 AND REGI_CODE LIKE '%'||#{CITY_CODE}||'%'
		         ]]>
		      </if>
		      <if test="KEYY_WORD != null">
		      	 <![CDATA[
		         	 AND (REGI_NAME    LIKE '%'||#{KEYY_WORD}||'%')
		         	  OR (PREGI_NAME   LIKE '%'||#{KEYY_WORD}||'%')
		         	  OR (CHILD_CATE   LIKE '%'||#{KEYY_WORD}||'%')
		         	  OR (PARENTS_CATE LIKE '%'||#{KEYY_WORD}||'%')
		         	  OR (GATH_TITL    LIKE '%'||#{KEYY_WORD}||'%')
		         	  OR (GATH_CNTT    LIKE '%'||#{KEYY_WORD}||'%')
		         	  OR (USER_NICK    LIKE '%'||#{KEYY_WORD}||'%')
		         	  OR GATH_IDXX IN (SELECT HASH_IDXX 
		         	                     FROM TB_HASHTG 
		         	                    WHERE HASH_TAGG LIKE '%'||#{KEYY_WORD}||'%')  
		         ]]>
		      </if>
		      	<![CDATA[
		      	ORDER BY REGG_DATE
		      	)
		      	]]>
      <if test="WEATH_CATE != null || CITY_CODE != null">
       <![CDATA[
      	   WHERE ROWNUM <= 12
      	]]>
      </if>
   </select>
   
    <!-- 게더 이미지 -->
	<select id="getGatherImg" parameterType='hashmap'
      resultType="hashmap">
      <![CDATA[
		  SELECT MOIM_IMAG
        FROM (
        	    SELECT GATH_IMAG AS MOIM_IMAG
                FROM VW_GATHER
               WHERE GATH_IDXX = #{MOIM_IDXX}

               UNION ALL

              SELECT FILE_PATH AS MOIM_IMAG
                FROM TM_FILEXM
               WHERE FILE_IDXX = #{MOIM_IDXX}
                 AND DELT_YSNO = 'N'
             )
	 		]]>
	</select>	
   
   	<!-- 
	작성자:Hwai
    작성일:23.12.19
    (게더 맴버 추출, 로그인 회원 마스터 유무.)
    -->
	<select id="getGatherMember" resultType="hashmap">
    <![CDATA[
        SELECT /*gather.getGahterMember*/
	             A.MOIM_IDXX														/* 모임번호 */		
	           , CASE WHEN A.USER_NUMB = C.USER_NUMB 			
                           THEN 'Y'
                      ELSE 'N'
                  END AS MAST_YSNO													/* 방장유무 */
	           , A.USER_NUMB														/* 회원번호 */
	           , B.USER_NICK														/* 회원닉네임 */
	           , B.SELF_INTR														/* 회원자기소개 */
	           , getuserimage(B.FILE_SVNM, B.USER_NUMB) AS USER_IMAG 				/* 회원프사 */
	           , A.BANN_YSNO														/* 강퇴유무 */
	           , A.WAIT_YSNO														/* 대기유무 */
	           , A.PART_DATE
	           ]]>
	           <if test="USER_NUMB != null">
		       <![CDATA[
	           , CASE WHEN A.BANN_YSNO = 'N' AND A.WAIT_YSNO = 'N' AND C.ENDD_YSNO = 'Y' AND D.REVW_IDXX IS NULL
                           THEN 'Y'
                      ELSE 'N'
                  END AS REVW_YSNO													/* 리뷰자격 */
               ]]>
               </if>
               <![CDATA[
	        FROM TB_MEMBER A
	   LEFT JOIN TM_USERXM B
	          ON A.USER_NUMB = B.USER_NUMB
	   LEFT JOIN TM_GATHER C
	          ON A.MOIM_IDXX = C.GATH_IDXX
	   LEFT JOIN TB_REVIEW D 
            ON A.MOIM_IDXX = D.MOIM_IDXX        
	       WHERE A.MOIM_IDXX = #{MOIM_IDXX}
	         ]]>
	         <if test="USER_NUMB != null">
		     <![CDATA[
	         AND A.USER_NUMB = #{USER_NUMB}
	         ]]>
	         </if>
	         <![CDATA[
	       ORDER BY A.PART_DATE
	      	]]>
    </select>
    
    <!-- 
	작성자:Hwai
    작성일:23.12.19
    (게더마감)
    -->
   <update id="setGatherEnd" parameterType="hashmap">
       <![CDATA[
      UPDATE /*gather.setGatherEnd*/
      		 TM_GATHER SET
		     ENDD_YSNO = 'Y'
	   WHERE GATH_IDXX = #{GATH_IDXX}
       ]]>
   </update>
</mapper>